---
import { formatDistance } from 'date-fns';
import { enUS, ja } from 'date-fns/locale';
import { Container, Divider, Stack, Wrap } from 'styled-system/jsx';
import { formatMonthYear, parseDate } from 'utils/date';
import { Markdown } from '~/components/lib/Markdown';
import { Heading } from '~/components/ui/heading';
import { Text } from '~/components/ui/text';
import { graphQLSdk } from '~/graphql';
import { useTranslations, validateLocale } from '~/i18n/utils';
import MainLayout from '~/layouts/MainLayout.astro';

export const prerender = false;
//TODO:

const { locale } = Astro.params;

if (!validateLocale(locale)) {
  return Astro.redirect(404);
}

const t = useTranslations(locale);

const data = await graphQLSdk.fetchAboutMe({
  locale
});

//TODO: Tags
const { aboutMe, educations, experiences, tags: _tags } = data ?? {};

Astro.response.headers.set('CDN-Cache-Control', 'public, max-age=3600, must-revalidate');
---

<MainLayout>
  <Container>
    <Stack p="4" w="full">
      <Heading as="h1" size="2xl" fontWeight="bold">{t('about-me.title')}</Heading>
      <Text>{aboutMe?.data?.attributes?.introduction}</Text>
      <Divider />
      <Stack>
        {
          experiences &&
            experiences.data?.map((d) => {
              if (!d.attributes) return null;
              const { title, content, position } = d.attributes;
              const start = d.attributes.start as string;
              const end = d.attributes.end as string;
              return (
                <Stack>
                  <Heading as="h2" size="xl" fontWeight="bold">
                    {title}
                  </Heading>
                  <Wrap fontSize="sm">
                    <Text>{position}</Text> <Text>|</Text>
                    <Text>
                      {formatMonthYear(parseDate(start), locale)} -{' '}
                      {end ? formatMonthYear(parseDate(end), locale) : t('common.present')} (
                      {formatDistance(parseDate(start), end ? parseDate(end) : new Date(), {
                        locale: locale === 'ja' ? ja : enUS
                      })}
                      )
                    </Text>
                  </Wrap>
                  {content && <Markdown content={content} />}
                </Stack>
              );
            })
        }
      </Stack>
      <Divider />
      <Stack>
        {
          educations &&
            educations.data?.map((d) => {
              if (!d.attributes) return null;
              const { title, description, content } = d.attributes;
              const start = d.attributes.start as string;
              const end = d.attributes.end as string;
              return (
                <Stack>
                  <Heading as="h2" size="xl" fontWeight="bold">
                    {title}
                  </Heading>
                  <Wrap fontSize="sm">
                    <Text>{description}</Text> <Text>|</Text>
                    <Text>
                      {formatMonthYear(parseDate(start), locale)} -{' '}
                      {end ? formatMonthYear(parseDate(end), locale) : t('common.present')}
                    </Text>
                  </Wrap>
                  {content && <Markdown content={content} />}
                </Stack>
              );
            })
        }
      </Stack>
    </Stack>
  </Container>
</MainLayout>
