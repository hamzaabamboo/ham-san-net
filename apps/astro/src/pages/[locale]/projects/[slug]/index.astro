---
//TODO:
import { Box, Container, Divider, Stack, styled } from 'styled-system/jsx';
import { getMediaUrl } from 'utils/media';
import { Carousel } from '~/components/common/Carousel';
import { LinkItem } from '~/components/common/LinkItem';
import { Markdown } from '~/components/lib/Markdown';
import { Heading } from '~/components/ui/heading';
import { graphQLSdk } from '~/graphql';
import { ComponentUtilsLink } from '~/graphql/generated/client';
import { useTranslations, validateLocale } from '~/i18n/utils';
import MainLayout from '~/layouts/MainLayout.astro';

export const prerender = false;

const { locale, slug } = Astro.params;

const data = await graphQLSdk.getProjectBySlug({
  slug
});

if (!validateLocale(locale)) {
  return Astro.redirect(404);
}

const { content, title, banner, links, media } = data?.projects?.data?.[0]?.attributes ?? {};
const { url: bannerPath, name: bannerName } = banner?.data?.attributes ?? {};
const bannerUrl = getMediaUrl(bannerPath, {}, import.meta.env.PUBLIC_API_URL);
const images =
  (media?.data
    .map((d) => getMediaUrl(d.attributes?.url, {}, import.meta.env.PUBLIC_API_URL))
    .filter((d) => !!d) as string[]) ?? [];
const t = useTranslations(locale);
---

<MainLayout>
  <Container maxW="breakpoint-xl" py="8">
    <Stack gap="4">
      {
        bannerUrl && (
          <Box rounded="l1" overflow="hidden">
            <styled.img
              src={bannerUrl}
              alt={bannerName ?? title ?? undefined}
              objectFit="cover"
              objectPosition="center"
              width="full"
              aspectRatio="16 / 9"
              transition:name={`project-image-${slug}`}
            />
          </Box>
        )
      }
      <Heading
        as="h1"
        size="2xl"
        fontWeight="bold"
        zIndex="99"
        transition:name={`project-title-${slug}`}>{title}</Heading
      >
      {
        links && (
          <Stack>
            {links
              .filter((l): l is ComponentUtilsLink => !!l)
              .map((l) => {
                return <LinkItem data={l} />;
              })}
          </Stack>
        )
      }
      <Divider />
      {content && <Markdown content={content} assetsPrefix={import.meta.env.PUBLIC_API_URL} />}
      {
        images.length > 0 && (
          <Stack>
            <Heading as="h2" size="xl" fontWeight="bold">
              {t('project.screenshots')}
            </Heading>
            <Carousel client:visible images={images} />
          </Stack>
        )
      }
    </Stack>
  </Container>
</MainLayout>
